#!/bin/sh

# Package
PACKAGE="RoonServer"
# Others
SSS="/var/packages/${PACKAGE}/scripts/start-stop-status"
ROON_PKG_URL="http://download.roonlabs.com/builds/RoonServer_linuxx64.tar.bz2"

preinst ()
{

    if [ "${SYNOPKG_PKG_STATUS}" != "UPGRADE" ]; then 
    	pushd /tmp
		rm -f RoonServer_linuxx64.tar.bz2
		curl -s -O "${ROON_PKG_URL}"
		R=$?
		if [ $R -eq 0 ]; then
			tar xjf RoonServer_linuxx64.tar.bz2 -C "${SYNOPKG_PKGINST_TEMP_DIR}"
			R=$?
		fi
		rm -f RoonServer_linuxx64.tar.bz2
		popd
		if [ $R -ne 0 ]; then
			echo "Could not download installation archive from Roon Labs website. Please check your internet connection."
		fi
		return $R
    fi
}

postinst ()
{
	mkdir -p /usr/local/bin
	ln -s ${INSTALL_DIR}/intofiy-tools/bin/inotifywait /usr/local/bin/inotifywait
	ln -s ${INSTALL_DIR}/inotify-tools/bin/inotifywatch /usr/local/bin/inotifywatch
	exit 0
}

preuninst ()
{
    # Stop the package
    ${SSS} stop > /dev/null
    
}

postuninst ()
{
    # Delete Package directory if it contains nothing.
    if [ ! -d "$(ls -A /usr/syno/etc/packages/${PACKAGE})" ]; then
        rm -Rf /usr/syno/etc/packages/${PACKAGE}
    fi
	rm -f /usr/local/bin/inotifywait
	rm -f /usr/local/bin/inotifywatch
    exit 0
}

preupgrade ()
{
    mv ${SYNOPKG_PKGDEST}/RoonServer ${SYNOPKG_PKGINST_TEMP_DIR}/RoonServer
    exit 0
}

postupgrade ()
{
    exit 0
}
