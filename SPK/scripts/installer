#!/bin/sh

# Package
PACKAGE="RoonServer"
DNAME="RoonServer"
# Others
SSS="/var/packages/${PACKAGE}/scripts/start-stop-status"
ROON_PKG_URL="http://download.roonlabs.com/builds/RoonServer_linuxx64.tar.bz2"

preinst ()
{

    if [ "${SYNOPKG_PKG_STATUS}" != "UPGRADE" ]; then 
        if [ "${wizard_dbimport_path}" != "" ]; then
            if [ ! -d "${wizard_dbimport_path}/RoonServer" ] & [ ! -d "${wizard_dbimport_path}/RAATServer" ]; then
          #      do_not_proceed="true"
                echo 'Import Error: Could not find required folders in your specified directory . ("RoonServer", "RAATServer")'
                exit 1
            fi
        fi
    curl "${ROON_PKG_URL}" | tar xvj -C ${SYNOPKG_PKGINST_TEMP_DIR} > /dev/null 2>&1
    fi

}

postinst ()
{
    if [ "${wizard_dbimport_path}" != "" ] && [ "${SYNOPKG_PKG_STATUS}" != "UPGRADE" ]; then
        mkdir "${SYNOPKG_PKGDEST}/Roon_Database"
        cp -r "${wizard_dbimport_path}/RoonServer" "${SYNOPKG_PKGDEST}/Roon_Database/RoonServer" > /dev/null 2>&1
        cp -r "${wizard_dbimport_path}/RAATServer" "${SYNOPKG_PKGDEST}/Roon_Database/RAATServer" > /dev/null 2>&1
    fi

}

preuninst ()
{
    # Stop the package
    ${SSS} stop > /dev/null
    
    ROON_EXPORT_FOLDER="${wizard_dbexport_path}/Roon_Database_$(date +%y%m%d_%H%M%S)"

    #Check user entry export path
    if [ "$wizard_dbexport_path" != "" ] && [ "${SYNOPKG_PKG_STATUS}" != "UPGRADE" ]; then
        if [ -d "${wizard_dbexport_path}" ] && [ ! -d "${ROON_EXPORT_FOLDER}" ]; then
            mv "${SYNOPKG_PKGDEST}/Roon_Database" "${ROON_EXPORT_FOLDER}"
            chown -R admin:users "${ROON_EXPORT_FOLDER}"
            sync
            echo "Roon-Database exported."
            exit 0
        else
            echo "Export failed! Check your export path entry. Aborting Uninstall."
            exit 1
        fi
    fi
}

postuninst ()
{

    # Delete Package directory if it contains nothing.
    if [ ! -d "$(ls -A /usr/syno/etc/packages/${PACKAGE})" ]; then
        rm -Rf /usr/syno/etc/packages/${PACKAGE}
    fi

    exit 0
}

preupgrade ()
{
    mv ${SYNOPKG_PKGDEST}/Roon_Database ${SYNOPKG_PKGINST_TEMP_DIR}/Roon_Database
    mv ${SYNOPKG_PKGDEST}/RoonServer ${SYNOPKG_PKGINST_TEMP_DIR}/RoonServer
    exit 0
}

postupgrade ()
{
    exit 0
}
